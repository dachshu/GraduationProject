# 뉴스 댓글 학습 및 생성 자동화 스크립트

전날의 다음에서 댓글이 가장 많은 뉴스 50개를 수집해서 그 댓글들을 학습하고, 학습된 모델로 새로운 뉴스 기사에 대한 댓글을 생성해 트위터에 업로드하는 자동화 스크립트.

## 작동 흐름

1. [다음 크롤러]를 사용해서 전날 댓글을 수집해 `${PROJECT_ROOT}/crawler/crawled_data/daum_news` 디렉터리에 날짜별로 저장한다. 크롤러는 출력으로 디렉터리 경로를 내보내는데 이 경로는 크롤러가 이번에 수집한 뉴스들이 저장된 경로이다.
2. [뉴스 필터]를 사용해서 수집된 뉴스의 댓글들 중에서 의미 있는 댓글들만 걸러낸다. 각 뉴스에서 비공감 수에 비해 공감 수가 높은 상위 10%의 댓글만을 출력한다. 이 때 비공감 수는 2배로 늘려서 계산에 사용한다. 전 단계에서 반환된 경로를 입력으로 넣어서 걸러진 뉴스와 댓글들을 반환한다.
3. [CharRNN 입력 생성 스크립트]에 위의 걸러진 뉴스 댓글들을 넣어서 CharRNN 모델이 학습에 사용할 수 있는 형태로 가공해서 출력한다. CharRNN 모델은 `input.txt` 파일이 있는 디렉토리를 입력으로 받아서 학습을 진행하기 때문에 출력을 `${PROJECT_ROOT}/results/${TODAY}/char_rnn_training_input/input.txt`로 리다이렉션 한다.
4. 학습에 사용할 입력이 준비된 후엔 CharRNN 모델 학습 스크립트를 실행해서 CharRNN 모델을 학습시킨다.
5. CharRNN 학습이 끝나면 [뉴스 필터]를 사용해서 NMT에 사용할 댓글들을 준비한다. NMT 모델은 incremental한 학습이 불가능하기 때문에 한번 학습시에 최대한 많은 댓글을 학습시켜야 한다. 여러번의 테스트 결과 이 댓글 수의 한계치는 7000개 내외인 것으로 보인다. 그래서 이 스크립트에선 2일 전의 뉴스들과 전날의 뉴스를 전부 필터링해서 NMT 모델 학습에 사용한다. 만약 2일 전의 뉴스들이 준비되어있지 않은 경우엔 [다음 크롤러]를 실행해 새롭게 수집한다.
6. 위의 필터링된 댓글들을 [NMT 입력 생성 스크립트]에 넘겨서 실제 입력 파일들을 만든다. 이 스크립트에서 댓글들을 7000개로 제한해서 출력한다. NMT 역시 CharRNN 모델처럼 입력 파일이 있는 디렉토리를 입력으로 받지만, CharRNN과는 다르게 다수의 입력파일을 요구한다. 때문에 이 스크립트는 stdout에 결과를 출력하지 않고 `${PROJECT_ROOT}/results/${TODAY}/nmt_training_input` 디렉토리 안에 여러 입력파일들을 작성한다.
7. NMT 모델 학습 스크립트를 실행해 NMT 모델을 학습시킨다.
8. Transformer 모델을 위한 데이터(120일 치 뉴스 제목과 댓글)를 수집하고 모델을 학습시킨다.
8. 학습된 모델들을 통해 댓글을 생성해 업로드 할 스케쥴을 생성한다. 가장 최근에 생성한 시간에 따라 새롭게 스케쥴을 생성한다. 처음 스케쥴을 생성하는 경우 최근 생성 시각을 '0'으로 설정한다. 이 가장 최근 생성된 시각은 `${PROJECT_ROOT}/CommentTimeGenerator/latest_generated_time` 파일에 기록되어 있다.
9. 생성된 스케쥴 중 이미 지나간 시간들은 무시하고, 남은 시간들에 대해 댓글 생성 스크립트를 at-job에 등록한다. 그 뒤 가장 마지막 시간을 최근 생성 시간으로 갱신한다.

[다음 크롤러]: ./daum_crawler.md
[뉴스 필터]: ./news_filter.md
[CharRNN 입력 생성 스크립트]: ./make_input_for_char_rnn.md
[NMT 입력 생성 스크립트]: ./make_input_for_nmt.md
